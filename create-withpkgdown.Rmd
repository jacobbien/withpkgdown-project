---
title: "Creating the ``r params$package_name`` R package"
author: "Your Name"
date: "The Date"
knit: litr::render
params:
  package_name: "withpkgdown" # <-- change this to your package name
  package_parent_dir: "." # <-- relative to this file's location
---

<!-- This Rmd file contains all the code needed to define an R package.  Press "Knit" in RStudio or more generally run `rmarkdown::render("name-of-this-file.Rmd")` to generate the R package.  Remember that when you want to modify anything about the R package, you should modify this document rather than the package that is outputted.
-->

## Package setup

We start by specifying the information needed in the DESCRIPTION file of the R package.

```{r package-setup, message=FALSE, results='hide'}
usethis::create_package(
  path = ".",
  fields = list(
    Package = params$package_name,
    Version = "0.0.0.9000",
    Title = "A Package That Has a pkgdown Site",
    Description = "This package's purpose is to show how to use pkgdown with litr.",
    `Authors@R` = person(
      given = "First",
      family = "Last",
      email = "you@gmail.com",
      role = c("aut", "cre")
      )
  )
)
usethis::use_mit_license(copyright_holder = "F. Last")
```

## Now to the package itself

### Define a function

Let's define a function for our R package:

```{r}
#' Say hello to someone
#' 
#' @param name Name of a person
#' @param exclamation Whether to include an exclamation mark
#' @export 
say_hello <- function(name, exclamation = TRUE) {
  paste0("Hello ", name, ifelse(exclamation, "!", "."))
}
```

Code chunks whose first line starts with `#'` are added to the package.

We can try running it.

```{r}
say_hello("Jacob")
```

That code chunk does not start with `#'`, so it is not added to the package.

Let's write some tests to make sure the function behaves as desired:

```{r}
testthat::test_that("say_hello works", {
  testthat::expect_equal(say_hello("Jacob"), "Hello Jacob!")
  testthat::expect_equal(say_hello("Jacob", exclamation = FALSE), "Hello Jacob.")
})
```

Code chunks that have one or more lines starting with `test_that(` (or `testthat::test_that(`) are added to the package as tests.

Let's also define a function that says hi:

```{r}
#' Say hi to someone
#' 
#' @param name Name of a person
#' @param exclamation Whether to include an exclamation mark
#' @export 
say_hi <- function(name, exclamation = TRUE) {
  paste0("Hi ", name, ifelse(exclamation, "!", "."))
}
```

## Documenting the package and building

Document package.

```{r}
rm(list = ls())
litr::document()
```

## Add a README

We include a `README.Rmd` and then generate the `README.md` based on it:

```{r}
usethis::use_readme_rmd(open = FALSE)
fs::file_copy(
  path = file.path("..", "withpkgdown-source-files", "README.Rmd"), 
  new_path = "README.Rmd", 
  overwrite = TRUE
)
xfun::Rscript_call(
  rmarkdown::render,
  args = list(
    input = "README.Rmd",
    output_options = list(html_preview = "false")
    )
  )
```

## Add a vignette

We'll define a function here that will soon be added to `litr`:

```{r}
add_vignettes <- function(rmd_files) {
  fs::dir_create("vignettes")
  for (fn in rmd_files) fs::file_copy(fn, "vignettes")
  
  # update DESCRIPTION file:
  litr:::add_text_to_file(txt = c("    knitr,", "    rmarkdown,"),
                        filename = "DESCRIPTION",
                        location = stringr::str_which(
                          readLines("DESCRIPTION"), "Suggests:") + 1
                        )
  litr:::add_text_to_file(txt = c("VignetteBuilder: knitr"),
                          filename = "DESCRIPTION")
}
```

```{r}
add_vignettes("../withpkgdown-source-files/using-this-package.Rmd")
```

## Add a pkgdown site

We start with the equivalent of `usethis::use_pkgdown()`, but with a few differences:

1. Avoid the parts to do with looking for projects
2. Allow one to use a custom `_pkgdown.yml`
3. Store `_pkgdown.yml` outside of package

```{r}
config_file <- "_pkgdown.yml"
destdir <- "docs"
usethis::use_build_ignore(c(config_file, destdir, "pkgdown"))
config_path <- file.path("../withpkgdown-source-files", "_pkgdown.yml")
if (!fs::file_exists(config_path)) {
  # create a new config file (note it lives outside of package)
  config <- usethis:::pkgdown_config(destdir)
  usethis::write_over(config_path, yaml::as.yaml(config))
}
fs::file_copy(config_path, ".")
```

Be sure that this next command is after `litr::document()` has been called.

```{r}
pkgdown::build_site()
```



